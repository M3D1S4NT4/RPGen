<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combate Pokémon</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .battle-arena {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .team-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .active-pokemon {
            text-align: center;
            margin-bottom: 20px;
        }

        .active-pokemon img {
            width: 200px;
            height: 200px;
            object-fit: contain;
        }

        .pokemon-stats {
            margin-top: 10px;
        }

        .health-bar {
            background-color: #ddd;
            width: 100%;
            height: 20px;
            border-radius: 10px;
            margin: 5px 0;
        }

        .health-bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease-in-out;
        }

        .team-pokemon {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .pokemon-card {
            background: #f5f5f5;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            position: relative;
        }

        .pokemon-card.active {
            border-color: #4CAF50;
            background-color: #e8f5e9;
        }

        .pokemon-card img {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }

        .moves-section {
            margin-top: 20px;
        }

        .moves-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .move-button {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }

        .move-button:hover {
            opacity: 0.8;
        }

        .battle-log {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .battle-log p {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        .type-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
            text-transform: capitalize;
            margin: 0 2px;
        }

        /* Colores de tipos */
        .type-normal { background-color: #A8A878; }
        .type-fire { background-color: #F08030; }
        .type-water { background-color: #6890F0; }
        .type-electric { background-color: #F8D030; }
        .type-grass { background-color: #78C850; }
        .type-ice { background-color: #98D8D8; }
        .type-fighting { background-color: #C03028; }
        .type-poison { background-color: #A040A0; }
        .type-ground { background-color: #E0C068; }
        .type-flying { background-color: #A890F0; }
        .type-psychic { background-color: #F85888; }
        .type-bug { background-color: #A8B820; }
        .type-rock { background-color: #B8A038; }
        .type-ghost { background-color: #705898; }
        .type-dragon { background-color: #7038F8; }
        .type-dark { background-color: #705848; }
        .type-steel { background-color: #B8B8D0; }
        .type-fairy { background-color: #EE99AC; }

        .team-selector {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .team-selector select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .start-battle {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .reset-button {
            background-color: #FF9800;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .reset-button:hover {
            background-color: #F57C00;
        }

        .pokemon-stats-tooltip {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            min-width: 200px;
            text-align: left;
        }

        .pokemon-card:hover .pokemon-stats-tooltip {
            display: block;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 14px;
        }

        .stat-label {
            font-weight: bold;
            color: #666;
        }

        .stat-value {
            color: #333;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }

        .attacking {
            animation: attack 1s ease-in-out;
        }
        
        .taking-damage {
            animation: take-damage 0.5s ease-in-out;
        }
        
        .move-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1.2em;
            z-index: 1000;
        }
        
        @keyframes attack {
            0% { transform: translateX(0); }
            25% { transform: translateX(50px); }
            50% { transform: translateX(0); }
            100% { transform: translateX(0); }
        }
        
        @keyframes take-damage {
            0% { transform: translateX(0); }
            25% { transform: translateX(-20px); }
            50% { transform: translateX(20px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }

        .pokemon-card.fainted {
            opacity: 0.5;
            filter: grayscale(100%);
            cursor: not-allowed;
        }
        .pokemon-card.fainted:hover {
            transform: none;
        }

        @keyframes attack {
            0% { transform: translateX(0); }
            25% { transform: translateX(50px); }
            50% { transform: translateX(0); }
            100% { transform: translateX(0); }
        }

        @keyframes hit {
            0% { transform: translateX(0); }
            25% { transform: translateX(-20px); }
            50% { transform: translateX(0); }
            100% { transform: translateX(0); }
        }

        .move-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1.2em;
            z-index: 1000;
        }

        @keyframes switchOut {
            0% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(-50px); }
        }

        @keyframes switchIn {
            0% { opacity: 0; transform: translateX(50px); }
            100% { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="margin-bottom: 20px;">
            <button onclick="window.location.href='pokemon.html'" style="background-color: #2196F3;">Ir a Pokédex</button>
        </div>
        <div class="team-selector">
            <select id="team1Selector">
                <option value="">Selecciona Equipo 1</option>
            </select>
            <select id="team2Selector">
                <option value="">Selecciona Equipo 2</option>
            </select>
            <button class="start-battle" onclick="startBattle()">Iniciar Batalla</button>
            <button id="resetBattle" class="reset-button" onclick="resetBattle()">Resetear Batalla</button>
        </div>

        <div class="battle-arena">
            <div class="team-section">
                <h2>Equipo 1</h2>
                <div class="active-pokemon">
                    <img id="team1ActivePokemon" src="" alt="Pokémon activo">
                    <div class="pokemon-stats">
                        <h3 id="team1PokemonName"></h3>
                        <div class="health-bar">
                            <div id="team1HealthBar" class="health-bar-fill" style="width: 100%; background-color: #4CAF50;"></div>
                        </div>
                        <p id="team1Health"></p>
                    </div>
                </div>
                <div class="moves-section">
                    <h3>Movimientos</h3>
                    <div id="team1Moves" class="moves-grid"></div>
                </div>
                <div class="team-pokemon" id="team1Pokemon"></div>
            </div>

            <div class="team-section">
                <h2>Equipo 2</h2>
                <div class="active-pokemon">
                    <img id="team2ActivePokemon" src="" alt="Pokémon activo">
                    <div class="pokemon-stats">
                        <h3 id="team2PokemonName"></h3>
                        <div class="health-bar">
                            <div id="team2HealthBar" class="health-bar-fill" style="width: 100%; background-color: #4CAF50;"></div>
                        </div>
                        <p id="team2Health"></p>
                    </div>
                </div>
                <div class="moves-section">
                    <h3>Movimientos</h3>
                    <div id="team2Moves" class="moves-grid"></div>
                </div>
                <div class="team-pokemon" id="team2Pokemon"></div>
            </div>
        </div>

        <div class="battle-log" id="battleLog">
            <p>Esperando inicio de batalla...</p>
        </div>
    </div>

    <script>
        let allTeams = {};
        let currentBattleId = null;
        let selectedTeam1 = null;
        let selectedTeam2 = null;
        let activePokemon1 = null;
        let activePokemon2 = null;
        let battleLog = [];
        let selectedMove1 = null;
        let selectedMove2 = null;
        let turnInProgress = false;
        let lastAction1 = null;
        let lastAction2 = null;
        let waitingForTeam1 = true;
        let waitingForTeam2 = true;
        let animationInProgress = false;
        let battleOver = false;
        const ATTACK_ANIMATION_DURATION = 1000; // Duración de la animación en milisegundos
        let initialSelectionPending = true; // Definición inicial de la bandera
        let actionSelected1 = false;  // Nueva variable para controlar si el equipo 1 ha seleccionado una acción
        let actionSelected2 = false;  // Nueva variable para controlar si el equipo 2 ha seleccionado una acción

        // API para comunicación con el backend
        const api = {
            async startBattle(team1, team2) {
                const response = await fetch('/api/pokemon-battle/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ team1, team2 })
                });
                if (!response.ok) {
                    throw new Error('Error al iniciar la batalla');
                }
                return await response.json();
            },

            async performAction(battleId, source, target, action) {
                if (!battleId) {
                    throw new Error('No hay una batalla activa');
                }
                const response = await fetch(`/api/pokemon-battle/${battleId}/action`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source, target, action })
                });
                if (!response.ok) {
                    throw new Error('Error al realizar la acción');
                }
                return await response.json();
            },

            async calculateTypeEffectiveness(data) {
                try {
                    const response = await fetch('/api/pokemon-battle/type-effectiveness', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            attackType: data.attackType,
                            defenderTypes: data.defenderTypes
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Error al calcular la efectividad de tipos');
                    }

                    const result = await response.json();
                    return result.effectiveness;
                } catch (error) {
                    console.error('Error en calculateTypeEffectiveness:', error);
                    throw error;
                }
            },

            async switchPokemon(battleId, newPokemon, isTeam1) {
                if (!battleId) {
                    throw new Error('No hay una batalla activa');
                }
                const response = await fetch(`/api/pokemon-battle/${battleId}/switch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newPokemon, isTeam1 })
                });
                if (!response.ok) {
                    throw new Error('Error al cambiar de Pokémon');
                }
                return await response.json();
            },

            async processTurn(battleId) {
                if (!battleId) {
                    throw new Error('No hay una batalla activa');
                }
                const response = await fetch(`/api/pokemon-battle/${battleId}/process-turn`, {
                    method: 'POST'
                });
                if (!response.ok) {
                    throw new Error('Error al procesar el turno');
                }
                return await response.json();
            }
        };

        // Función para habilitar/deshabilitar botones de movimientos y cambios
        function setMoveAndSwitchButtonsEnabled(enabled) {
            // Deshabilitar todos los botones si el turno está en progreso o la batalla ha terminado
            const shouldDisable = !enabled || turnInProgress || battleOver;
            
            // Actualizar botones de movimientos
            document.querySelectorAll('.move-button').forEach(btn => {
                btn.disabled = shouldDisable;
            });
            
            // Actualizar botones de cambio de Pokémon
            document.querySelectorAll('.pokemon-card').forEach(card => {
                const pokemon = card.dataset.pokemonId;
                const team = card.dataset.team;
                
                // Solo habilitar si el Pokémon tiene HP > 0 y su equipo no ha seleccionado una acción
                const pokemonData = team === 'team1' ? 
                    selectedTeam1.find(p => p.uniqueId === pokemon) :
                    selectedTeam2.find(p => p.uniqueId === pokemon);
                
                const hasSelectedAction = team === 'team1' ? 
                    (selectedMove1 || lastAction1 === 'move') :
                    (selectedMove2 || lastAction2 === 'move');
                
                if (pokemonData && pokemonData.health > 0 && !hasSelectedAction) {
                    card.style.pointerEvents = shouldDisable ? 'none' : 'auto';
                    card.style.opacity = shouldDisable ? '0.5' : '1';
                } else {
                    card.style.pointerEvents = 'none';
                    card.style.opacity = '0.5';
                }
            });
        }

        // Función para actualizar la barra de vida con animación
        function updateHealthBar(pokemon, newHealth) {
            // Determinar si es un Pokémon activo principal o una tarjeta pequeña
            let healthBarElement;
            let healthTextElement;

            // Comprobar si el Pokémon es el activo del equipo 1 o equipo 2 basándose en el uniqueId
            if (activePokemon1 && pokemon.uniqueId === activePokemon1.uniqueId) {
                healthBarElement = document.getElementById('team1HealthBar');
                healthTextElement = document.getElementById('team1Health');
            } else if (activePokemon2 && pokemon.uniqueId === activePokemon2.uniqueId) {
                healthBarElement = document.getElementById('team2HealthBar');
                healthTextElement = document.getElementById('team2Health');
            } else {
                // Es una tarjeta pequeña de Pokémon
                healthBarElement = document.querySelector(`[data-pokemon-id="${pokemon.uniqueId}"] .health-bar-fill`);
                healthTextElement = document.querySelector(`[data-pokemon-id="${pokemon.uniqueId}"] div:last-of-type`);
            }

            if (!healthBarElement) return;
            
            // Obtener el porcentaje de salud actual del elemento DOM
            const currentHealthPercentage = parseFloat(healthBarElement.style.width) || 0;
            const targetHealthPercentage = (newHealth / pokemon.maxHealth) * 100;
            const healthColor = targetHealthPercentage > 50 ? '#4CAF50' : targetHealthPercentage > 25 ? '#FFA500' : '#FF4444';
            
            // Animar la reducción de la barra de vida
            const duration = 500; // duración de la animación en ms
            const startTime = performance.now();
            
            function animate(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                const animatedWidth = currentHealthPercentage - (currentHealthPercentage - targetHealthPercentage) * progress;
                healthBarElement.style.width = `${animatedWidth}%`;
                healthBarElement.style.backgroundColor = healthColor; // Asegurar que el color también se actualice

                if (healthTextElement) {
                    // Para la animación del texto, es mejor interpolar entre la salud actual y la nueva salud
                    const currentDisplayedHealth = Math.round((currentHealthPercentage / 100) * pokemon.maxHealth); // Estimación de la salud actual mostrada
                    const animatedHealth = Math.round(currentDisplayedHealth - (currentDisplayedHealth - newHealth) * progress);
                    healthTextElement.textContent = `HP: ${animatedHealth}/${pokemon.maxHealth}`;
                }
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    // Asegurarse de que el valor final sea exacto
                    healthBarElement.style.width = `${targetHealthPercentage}%`;
                    if (healthTextElement) {
                        healthTextElement.textContent = `HP: ${newHealth}/${pokemon.maxHealth}`;
                    }
                }
            }
            
            requestAnimationFrame(animate);
        }

        // Actualizar movimientos
        function updateMoves(teamId, pokemon) {
            const movesContainer = document.getElementById(`${teamId}Moves`);
            movesContainer.innerHTML = '';

            if (!pokemon || !pokemon.moves) {
                console.warn('No hay movimientos disponibles para', pokemon?.name);
                return;
            }

            // Solo mostrar los movimientos seleccionados
            const selectedMoves = pokemon.selectedMoveIndices ? 
                pokemon.selectedMoveIndices.map(index => pokemon.moves[index]).filter(move => move) :
                [];

            selectedMoves.forEach(move => {
                if (!move) {
                    console.warn('Movimiento nulo encontrado en', pokemon.name);
                    return;
                }
                
                const button = document.createElement('button');
                button.className = 'move-button';
                button.textContent = `${move.name} (${move.power})`;
                button.addEventListener('click', () => selectMove(teamId, move));
                movesContainer.appendChild(button);
            });
        }

        // Actualizar lista de Pokémon del equipo
        function updateTeamPokemon(teamId, team) {
            const container = document.getElementById(`${teamId}Pokemon`);
            container.innerHTML = '';

            team.forEach(pokemon => {
                const card = document.createElement('div');
                card.className = 'pokemon-card';
                card.dataset.pokemonId = pokemon.uniqueId;
                card.dataset.team = teamId;
                
                // Añadir clase si es el Pokémon activo
                if ((teamId === 'team1' && activePokemon1 && activePokemon1.id === pokemon.id) ||
                    (teamId === 'team2' && activePokemon2 && activePokemon2.id === pokemon.id)) {
                    card.classList.add('active');
                }

                // Añadir clase si el Pokémon está debilitado
                if (pokemon.health <= 0) {
                    card.classList.add('fainted');
                }

                // Calcular el porcentaje de HP para la barra de vida
                const hpPercentage = (pokemon.health / pokemon.maxHealth) * 100;

                card.innerHTML = `
                    <img src="${pokemon.imageUrl}" alt="${pokemon.name}">
                    <h3>${pokemon.name}</h3>
                    <div class="health-bar">
                        <div class="health-bar-fill" style="width: ${hpPercentage}%;"></div>
                    </div>
                    <p>HP: ${pokemon.health}/${pokemon.maxHealth}</p>
                `;

                // Solo permitir seleccionar Pokémon con HP > 0
                if (pokemon.health > 0) {
                    card.addEventListener('click', async () => {
                        // Si no hay batalla activa, solo seleccionar el Pokémon inicial
                        if (!currentBattleId) {
                            if (teamId === 'team1') {
                                activePokemon1 = pokemon;
                            } else {
                                activePokemon2 = pokemon;
                            }
                            updateBattleDisplay();
                            return;
                        }

                        // Lógica para cambio durante la batalla
                        if (turnInProgress || battleOver) return;
                        
                        const selectedMove = teamId === 'team1' ? selectedMove1 : selectedMove2;
                        const lastAction = teamId === 'team1' ? lastAction1 : lastAction2;
                        
                        if (selectedMove || lastAction === 'move') {
                            updateBattleLog(`El ${teamId === 'team1' ? 'Equipo 1' : 'Equipo 2'} ya ha seleccionado un movimiento en este turno`);
                            return;
                        }

                        try {
                            pokemon.team = teamId;
                            const result = await api.switchPokemon(currentBattleId, pokemon, teamId === 'team1');
                            
                            if (result.error) {
                                updateBattleLog(result.error);
                                return;
                            }

                            if (result.message) {
                                if (teamId === 'team1') {
                                    // Preservar el HP del Pokémon activo
                                    const currentHP = activePokemon1 ? activePokemon1.health : 0;
                                    activePokemon1 = {...result.newActivePokemon, team: 'team1'};
                                    if (currentHP > 0) {
                                        activePokemon1.health = currentHP;
                                    }
                                    selectedMove1 = null;
                                    lastAction1 = 'switch';
                                    waitingForTeam1 = false;
                                } else {
                                    // Preservar el HP del Pokémon activo
                                    const currentHP = activePokemon2 ? activePokemon2.health : 0;
                                    activePokemon2 = {...result.newActivePokemon, team: 'team2'};
                                    if (currentHP > 0) {
                                        activePokemon2.health = currentHP;
                                    }
                                    selectedMove2 = null;
                                    lastAction2 = 'switch';
                                    waitingForTeam2 = false;
                                }

                                if (result.battleOver !== undefined) {
                                    battleOver = result.battleOver;
                                }

                                // Actualizar la interfaz inmediatamente
                                updateBattleDisplay();
                                updateMoveButtons();
                                updateBattleLog(`${pokemon.name} ha entrado en combate`);

                                // Si ambos equipos han seleccionado una acción, procesar el turno
                                if (!waitingForTeam1 && !waitingForTeam2) {
                                    turnInProgress = true;
                                    // Actualizar los botones antes de procesar el turno
                                    setMoveAndSwitchButtonsEnabled(false);
                                    await processTurn();
                                } else {
                                    // Si aún esperamos una acción, actualizar los botones apropiadamente
                                    setMoveAndSwitchButtonsEnabled(true);
                                    updateBattleLog(`Esperando a que el ${waitingForTeam1 ? 'Equipo 1' : 'Equipo 2'} seleccione una acción`);
                                }
                            }
                        } catch (error) {
                            console.error('Error al cambiar Pokémon:', error);
                            updateBattleLog(`Error al cambiar Pokémon: ${error.message}`);
                        }
                    });
                }

                container.appendChild(card);
            });
        }

        // --- Funciones principales de la batalla ---

        // Seleccionar movimiento
        function selectMove(teamId, move) {
            if (turnInProgress || battleOver) return;

            const selectedMove = teamId === 'team1' ? selectedMove1 : selectedMove2;
            const lastAction = teamId === 'team1' ? lastAction1 : lastAction2;

            if (lastAction === 'switch') {
                updateBattleLog(`El ${teamId === 'team1' ? 'Equipo 1' : 'Equipo 2'} ya ha cambiado de Pokémon en este turno`);
                return;
            }

            if (teamId === 'team1') {
                selectedMove1 = move;
                lastAction1 = 'move';
                waitingForTeam1 = false;
            } else {
                selectedMove2 = move;
                lastAction2 = 'move';
                waitingForTeam2 = false;
            }

            updateBattleDisplay();
            setMoveAndSwitchButtonsEnabled(true);

            if (!waitingForTeam1 && !waitingForTeam2) {
                turnInProgress = true;
                processTurn();
            } else {
                updateBattleLog(`Esperando a que el ${waitingForTeam1 ? 'Equipo 1' : 'Equipo 2'} seleccione una acción`);
            }
        }

        async function processTurn() {
            // Resetear las variables de selección de acción
            actionSelected1 = false;
            actionSelected2 = false;
            waitingForTeam1 = true;
            waitingForTeam2 = true;

            // Determinar el orden de ataque basado en la velocidad
            const firstAttacker = activePokemon1.speed >= activePokemon2.speed ? 
                { pokemon: activePokemon1, move: selectedMove1, team: 'team1' } : 
                { pokemon: activePokemon2, move: selectedMove2, team: 'team2' };
            
            const secondAttacker = firstAttacker.team === 'team1' ? 
                { pokemon: activePokemon2, move: selectedMove2, team: 'team2' } : 
                { pokemon: activePokemon1, move: selectedMove1, team: 'team1' };

            // Esperar un momento antes de comenzar el turno
            await new Promise(resolve => setTimeout(resolve, 500));

            // Realizar el primer ataque si hay un movimiento seleccionado
            if (firstAttacker.move) {
                await performAttack(firstAttacker, secondAttacker.pokemon);
            }
            
            // Verificar si el segundo Pokémon ha sido derrotado
            if (secondAttacker.pokemon.health <= 0) {
                updateBattleLog(`${secondAttacker.pokemon.name} ha sido derrotado!`);
                if (checkBattleEnd()) {
                    turnInProgress = false;
                    selectedMove1 = null;
                    selectedMove2 = null;
                    updateBattleDisplay();
                    return;
                }
                
                updateBattleLog(`¡${secondAttacker.team === 'team1' ? 'Equipo 1' : 'Equipo 2'} debe seleccionar un nuevo Pokémon!`);
                // Deshabilitar la selección de movimientos hasta que se seleccione un nuevo Pokémon
                if (secondAttacker.team === 'team1') {
                    activePokemon1 = null;
                } else {
                    activePokemon2 = null;
                }
                updateBattleDisplay();
                // Pasar al siguiente turno automáticamente
                turnInProgress = false;
                selectedMove1 = null;
                selectedMove2 = null;
                actionSelected1 = false;
                actionSelected2 = false;
                setMoveAndSwitchButtonsEnabled(true);
                return;
            }

            // Realizar el segundo ataque si hay un movimiento seleccionado
            if (secondAttacker.move) {
                await performAttack(secondAttacker, firstAttacker.pokemon);
            }

            // Verificar si el primer Pokémon ha sido derrotado
            if (firstAttacker.pokemon.health <= 0) {
                updateBattleLog(`${firstAttacker.pokemon.name} ha sido derrotado!`);
                if (checkBattleEnd()) {
                    turnInProgress = false;
                    selectedMove1 = null;
                    selectedMove2 = null;
                    updateBattleDisplay();
                    return;
                }
                
                updateBattleLog(`¡${firstAttacker.team === 'team1' ? 'Equipo 1' : 'Equipo 2'} debe seleccionar un nuevo Pokémon!`);
                // Deshabilitar la selección de movimientos hasta que se seleccione un nuevo Pokémon
                if (firstAttacker.team === 'team1') {
                    activePokemon1 = null;
                } else {
                    activePokemon2 = null;
                }
                updateBattleDisplay();
            }

            // Resetear los movimientos seleccionados y el estado del turno
            selectedMove1 = null;
            selectedMove2 = null;
            turnInProgress = false;
            lastAction1 = null;
            lastAction2 = null;
            updateBattleDisplay();

            // Esperar por las acciones de ambos equipos
            updateBattleLog('Esperando a que ambos equipos seleccionen una acción');
            setMoveAndSwitchButtonsEnabled(true);
        }

        async function performAttack(attacker, defender) {
            try {
                // Asegurarnos de que el Pokémon atacante tenga el equipo correcto
                attacker.pokemon.team = attacker.team;
                
                // Verificar que el movimiento existe
                if (!attacker.move) {
                    console.error('No hay movimiento seleccionado para el atacante:', attacker);
                    updateBattleLog('Error: No hay movimiento seleccionado');
                    return;
                }

                // Animar el ataque
                await animateAttack(attacker.pokemon, defender);

                // Calcular la efectividad del ataque
                const effectiveness = await api.calculateTypeEffectiveness({
                    attackType: attacker.move.type,
                    defenderTypes: defender.types
                });

                // Calcular el daño
                const damage = calculateDamage(attacker.pokemon, defender, attacker.move, effectiveness);

                // Aplicar el daño
                defender.health = Math.max(0, defender.health - damage);

                // Mostrar mensaje de ataque
                let message = `${attacker.pokemon.name} ha usado ${attacker.move.name} y ha infligido ${damage} de daño a ${defender.name}`;
                
                // Añadir mensaje de efectividad
                if (effectiveness > 1) {
                    message += '\n¡Es super efectivo!';
                } else if (effectiveness < 1) {
                    message += '\nNo es muy efectivo...';
                }

                updateBattleLog(message);
                updateBattleDisplay();

            } catch (error) {
                console.error('Error al realizar el ataque:', error);
                updateBattleLog('Error al realizar el ataque');
            }
        }

        function calculateDamage(attacker, defender, move, effectiveness) {
            // Fórmula simplificada de daño base
            const attack = move.category === 'physical' ? attacker.attack : attacker.specialAttack;
            const defense = move.category === 'physical' ? defender.defense : defender.specialDefense;
            
            let damage = ((2 * 50 / 5 + 2) * move.power * (attack / defense)) / 50 + 2;
            
            // Aplicar variación aleatoria (85-100%)
            damage *= (0.85 + Math.random() * 0.15);
            
            // Aplicar la efectividad de tipos
            damage *= effectiveness;
            
            return Math.floor(damage);
        }

        // Cambiar Pokémon
        async function switchPokemon(pokemon, teamId) {
            if (turnInProgress || battleOver) return;

            const selectedMove = teamId === 'team1' ? selectedMove1 : selectedMove2;
            const lastAction = teamId === 'team1' ? lastAction1 : lastAction2;

            if (selectedMove || lastAction === 'move') {
                updateBattleLog(`El ${teamId === 'team1' ? 'Equipo 1' : 'Equipo 2'} ya ha seleccionado un movimiento en este turno`);
                return;
            }

            try {
                pokemon.team = teamId;
                
                const result = await api.switchPokemon(currentBattleId, pokemon, teamId === 'team1');
                if (result.error) {
                    updateBattleLog(result.error);
                    return;
                }

                if (result.message) {
                    if (teamId === 'team1') {
                        activePokemon1 = {...result.newActivePokemon, team: 'team1'};
                        selectedMove1 = null;
                        lastAction1 = 'switch';
                        waitingForTeam1 = false;
                    } else {
                        activePokemon2 = {...result.newActivePokemon, team: 'team2'};
                        selectedMove2 = null;
                        lastAction2 = 'switch';
                        waitingForTeam2 = false;
                    }

                    if (result.battleOver !== undefined) {
                        battleOver = result.battleOver;
                    }

                    updateBattleDisplay();
                    updateMoveButtons();
                    updateBattleLog(`${pokemon.name} ha entrado en combate`);

                    if (!waitingForTeam1 && !waitingForTeam2) {
                        turnInProgress = true;
                        await processTurn();
                    } else {
                        updateBattleLog(`Esperando a que el ${waitingForTeam1 ? 'Equipo 1' : 'Equipo 2'} seleccione una acción`);
                    }
                }
            } catch (error) {
                console.error('Error al cambiar Pokémon:', error);
                updateBattleLog(`Error al cambiar Pokémon: ${error.message}`);
            }
        }

        // Cargar equipos guardados
        function loadTeams() {
            const savedTeams = localStorage.getItem('pokemonTeams');
            console.log('LoadTeams - savedTeams from localStorage:', savedTeams);
            if (savedTeams) {
                try {
                    const teamsData = JSON.parse(savedTeams);
                    console.log('Equipos cargados (parsed):', teamsData);
                    
                    allTeams = {};
                    let uniqueCounter = 0; // Contador para uniqueId
                    for (const [teamName, teamHashes] of Object.entries(teamsData)) {
                        allTeams[teamName] = teamHashes.map((pokemonHash, idx) => {
                            console.log(`Buscando datos para Pokémon: ${pokemonHash}`);
                            const pokemonData = localStorage.getItem(pokemonHash);
                            if (!pokemonData) {
                                console.warn(`No se encontraron datos para el Pokémon ${pokemonHash}`);
                                return null;
                            }
                            try {
                                const parsedData = JSON.parse(pokemonData);
                                // Asignar un identificador único aunque sean iguales
                                parsedData.uniqueId = `${parsedData.id}_${teamName}_${idx}_${Date.now()}_${uniqueCounter++}`;
                                return parsedData;
                            } catch (e) {
                                console.error(`Error al parsear datos del Pokémon ${pokemonHash}:`, e);
                                return null;
                            }
                        }).filter(pokemon => pokemon !== null);
                    }
                    
                    console.log('Equipos procesados (allTeams):', allTeams);
                    
                    // Verificar que los equipos tengan datos válidos
                    for (const [teamName, team] of Object.entries(allTeams)) {
                        if (!Array.isArray(team) || team.length === 0) {
                            console.error(`El equipo ${teamName} no tiene Pokémon válidos`);
                            delete allTeams[teamName];
                        }
                    }
                    
                    if (Object.keys(allTeams).length === 0) {
                        throw new Error('No se encontraron equipos válidos');
                    }
                    
                    updateTeamSelectors();

                } catch (error) {
                    console.error('Error al cargar equipos:', error);
                    alert('Error al cargar los equipos: ' + error.message);
                }
            } else {
                console.log('No hay equipos guardados');
                alert('No hay equipos guardados. Por favor, crea equipos en la página de Pokédex.');
                window.location.href = 'pokemon.html';
            }
        }

        // Actualizar selectores de equipos
        function updateTeamSelectors() {
            const team1Selector = document.getElementById('team1Selector');
            const team2Selector = document.getElementById('team2Selector');
            
            team1Selector.innerHTML = '<option value="">Selecciona Equipo 1</option>';
            team2Selector.innerHTML = '<option value="">Selecciona Equipo 2</option>';
            
            for (const teamName in allTeams) {
                const teamData = allTeams[teamName];
                if (Array.isArray(teamData) && teamData.length > 0) {
                    team1Selector.innerHTML += `<option value="${teamName}">${teamName}</option>`;
                    team2Selector.innerHTML += `<option value="${teamName}">${teamName}</option>`;
                }
            }

            // Agregar event listeners para los cambios en los selectores
            team1Selector.addEventListener('change', function() {
                selectedTeam1 = this.value ? allTeams[this.value] : null;
                if (selectedTeam1 && selectedTeam1.length > 0) {
                    // No seleccionar automáticamente, mostrar opciones
                    activePokemon1 = null;
                    console.log('Equipo 1 seleccionado:', selectedTeam1);
                    updateTeamPokemon('team1', selectedTeam1);
                }
                updateBattleDisplay();
            });

            team2Selector.addEventListener('change', function() {
                selectedTeam2 = this.value ? allTeams[this.value] : null;
                if (selectedTeam2 && selectedTeam2.length > 0) {
                    // No seleccionar automáticamente, mostrar opciones
                    activePokemon2 = null;
                    console.log('Equipo 2 seleccionado:', selectedTeam2);
                    updateTeamPokemon('team2', selectedTeam2);
                }
                updateBattleDisplay();
            });

            // No seleccionar equipos por defecto
            updateBattleDisplay();
        }

        // --- Funciones adicionales ---

        function updateBattleDisplay() {
            // Actualizar Pokémon activo del Equipo 1
            if (activePokemon1) {
                document.getElementById('team1ActivePokemon').src = activePokemon1.imageUrl;
                document.getElementById('team1PokemonName').textContent = activePokemon1.name;
                const healthPercentage1 = (activePokemon1.health / activePokemon1.maxHealth) * 100;
                document.getElementById('team1HealthBar').style.width = `${healthPercentage1}%`;
                document.getElementById('team1Health').textContent = `HP: ${activePokemon1.health}/${activePokemon1.maxHealth}`;
                updateMoves('team1', activePokemon1);
            } else {
                document.getElementById('team1ActivePokemon').src = '';
                document.getElementById('team1PokemonName').textContent = 'Selecciona un Pokémon';
                document.getElementById('team1Health').textContent = '';
                document.getElementById('team1HealthBar').style.width = '0%';
                document.getElementById('team1Moves').innerHTML = '';
            }

            // Actualizar Pokémon activo del Equipo 2
            if (activePokemon2) {
                document.getElementById('team2ActivePokemon').src = activePokemon2.imageUrl;
                document.getElementById('team2PokemonName').textContent = activePokemon2.name;
                const healthPercentage2 = (activePokemon2.health / activePokemon2.maxHealth) * 100;
                document.getElementById('team2HealthBar').style.width = `${healthPercentage2}%`;
                document.getElementById('team2Health').textContent = `HP: ${activePokemon2.health}/${activePokemon2.maxHealth}`;
                updateMoves('team2', activePokemon2);
            } else {
                document.getElementById('team2ActivePokemon').src = '';
                document.getElementById('team2PokemonName').textContent = 'Selecciona un Pokémon';
                document.getElementById('team2Health').textContent = '';
                document.getElementById('team2HealthBar').style.width = '0%';
                document.getElementById('team2Moves').innerHTML = '';
            }

            // Actualizar lista de Pokémon de cada equipo
            if (selectedTeam1) {
                updateTeamPokemon('team1', selectedTeam1);
            } else {
                document.getElementById('team1Pokemon').innerHTML = '';
            }

            if (selectedTeam2) {
                updateTeamPokemon('team2', selectedTeam2);
            } else {
                document.getElementById('team2Pokemon').innerHTML = '';
            }

            // Habilitar/deshabilitar botones según el estado de la batalla
            setMoveAndSwitchButtonsEnabled(!battleOver && !turnInProgress);
        }

        function startBattle() {
            console.log('Intentando iniciar batalla:');
            console.log('selectedTeam1:', selectedTeam1);
            console.log('selectedTeam2:', selectedTeam2);
            console.log('activePokemon1:', activePokemon1);
            console.log('activePokemon2:', activePokemon2);

            if (!selectedTeam1 || !selectedTeam2) {
                updateBattleLog('Por favor, selecciona ambos equipos antes de iniciar la batalla');
                return;
            }

            if (!activePokemon1 || !activePokemon2) {
                // Intentar seleccionar automáticamente los primeros Pokémon si no están seleccionados
                if (!activePokemon1 && selectedTeam1.length > 0) {
                    activePokemon1 = selectedTeam1[0];
                }
                if (!activePokemon2 && selectedTeam2.length > 0) {
                    activePokemon2 = selectedTeam2[0];
                }
                
                // Verificar nuevamente después de intentar la selección automática
                if (!activePokemon1 || !activePokemon2) {
                    updateBattleLog('Por favor, selecciona los Pokémon iniciales para ambos equipos');
                    return;
                }
            }

            // Iniciar la batalla en el backend
            api.startBattle(selectedTeam1, selectedTeam2)
                .then(result => {
                    if (result.error) {
                        updateBattleLog(result.error);
                        return;
                    }

                    currentBattleId = result.battleId;
                    turnInProgress = false;
                    battleOver = false;
                    initialSelectionPending = false;
                    updateBattleDisplay();
                    updateBattleLog('¡La batalla ha comenzado!');
                })
                .catch(error => {
                    console.error('Error al iniciar la batalla:', error);
                    updateBattleLog(`Error al iniciar la batalla: ${error.message}`);
                });
        }

        function resetBattle() {
            // Resetear variables de batalla
            battleOver = false;
            selectedMove1 = null;
            selectedMove2 = null;
            activePokemon1 = null;
            activePokemon2 = null;
            turnInProgress = false;
            actionSelected1 = false;  // Resetear la selección de acción del equipo 1
            actionSelected2 = false;  // Resetear la selección de acción del equipo 2

            // Regenerar HP de todos los Pokémon en ambos equipos
            if (selectedTeam1) {
                selectedTeam1.forEach(pokemon => {
                    pokemon.health = pokemon.maxHealth;
                });
            }
            if (selectedTeam2) {
                selectedTeam2.forEach(pokemon => {
                    pokemon.health = pokemon.maxHealth;
                });
            }

            // Limpiar el registro de batalla
            battleLog.innerHTML = '';
            updateBattleLog('¡La batalla ha comenzado!');

            // Actualizar la interfaz
            updateBattleDisplay();
            updateMoveButtons();
        }

        function updateMoveButtons() {
            const team1Moves = document.getElementById('team1Moves');
            const team2Moves = document.getElementById('team2Moves');
            
            // Limpiar los botones existentes
            team1Moves.innerHTML = '';
            team2Moves.innerHTML = '';

            // Mostrar los movimientos del equipo que no ha seleccionado una acción
            if (activePokemon1 && !selectedMove1 && !lastAction1) {
                activePokemon1.moves.forEach(move => {
                    const button = document.createElement('button');
                    button.className = 'move-button';
                    button.textContent = move.name;
                    button.onclick = () => selectMove('team1', move);
                    button.disabled = turnInProgress || battleOver;
                    team1Moves.appendChild(button);
                });
            }

            if (activePokemon2 && !selectedMove2 && !lastAction2) {
                activePokemon2.moves.forEach(move => {
                    const button = document.createElement('button');
                    button.className = 'move-button';
                    button.textContent = move.name;
                    button.onclick = () => selectMove('team2', move);
                    button.disabled = turnInProgress || battleOver;
                    team2Moves.appendChild(button);
                });
            }

            // Actualizar el estado de los botones
            setMoveAndSwitchButtonsEnabled(!turnInProgress && !battleOver);
        }

        async function animateAttack(source, target) {
            return new Promise((resolve) => {
                // Buscar los elementos de los Pokémon en la arena de batalla
                const sourceElement = document.querySelector(`.pokemon-card[data-pokemon-id="${source.uniqueId}"].active`);
                const targetElement = document.querySelector(`.pokemon-card[data-pokemon-id="${target.uniqueId}"].active`);

                if (!sourceElement || !targetElement) {
                    console.warn('No se encontraron elementos para animar:', { source, target });
                    resolve();
                    return;
                }

                // Determinar qué movimiento mostrar basado en el equipo del Pokémon atacante
                let moveToShow;
                if (source.team === 'team1') {
                    moveToShow = selectedMove1;
                } else if (source.team === 'team2') {
                    moveToShow = selectedMove2;
                }

                if (!moveToShow) {
                    console.warn('No se encontró el movimiento para mostrar:', { source, target });
                    resolve();
                    return;
                }

                // Crear el texto del movimiento
                const moveText = document.createElement('div');
                moveText.className = 'move-text';
                moveText.textContent = `${source.name} usa ${moveToShow.name}!`;
                document.querySelector('.battle-arena').appendChild(moveText);

                // Aplicar la animación de ataque
                sourceElement.classList.add('attacking');
                targetElement.classList.add('taking-damage');

                // Limpiar las animaciones después de que terminen
                setTimeout(() => {
                    sourceElement.classList.remove('attacking');
                    targetElement.classList.remove('taking-damage');
                    moveText.remove();
                    resolve();
                }, ATTACK_ANIMATION_DURATION);
            });
        }

        // Función para verificar si un equipo está derrotado
        function isTeamDefeated(team) {
            return team.every(pokemon => pokemon.health <= 0);
        }

        // Función para verificar si la batalla ha terminado
        function checkBattleEnd() {
            if (!selectedTeam1 || !selectedTeam2) return false;
            
            const team1Defeated = isTeamDefeated(selectedTeam1);
            const team2Defeated = isTeamDefeated(selectedTeam2);
            
            if (team1Defeated || team2Defeated) {
                battleOver = true;
                const winner = team1Defeated ? 'Equipo 2' : 'Equipo 1';
                updateBattleLog(`¡La batalla ha terminado! ${winner} ha ganado.`);
                return true;
            }
            return false;
        }

        // Actualizar registro de batalla
        function updateBattleLog(message) {
            battleLog.push(message);
            const battleLogElement = document.getElementById('battleLog');
            battleLogElement.innerHTML = battleLog.map(msg => `<p>${msg}</p>`).join('');
            battleLogElement.scrollTop = battleLogElement.scrollHeight;
        }
    </script>
    <script>
        // Cargar equipos cuando se carga la página
        document.addEventListener('DOMContentLoaded', loadTeams);
    </script>
</body>
</html>
