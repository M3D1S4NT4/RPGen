<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pok√©dex</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode {
            background-color: #181818;
            color: #f0f0f0;
        }

        .container {
            max-width: calc(100% - 500px);
            margin: 0 auto;
            padding: 20px;
        }

        .search-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        body.dark-mode .search-bar input {
            background: #232323;
            color: #f0f0f0;
            border: 2px solid #444;
        }

        .pokemon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .pokemon-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s, background-color 0.3s, color 0.3s, border-color 0.3s;
            position: relative;
        }
        .pokemon-card:hover {
            transform: translateY(-5px);
            z-index: 1001;
        }
        body.dark-mode .pokemon-card {
            background: #232323;
            color: #e0e0e0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            border: 1px solid #444;
        }
        body.dark-mode .pokemon-card.selected {
            background: #294d29;
            border-color: #6fcf97;
        }
        body.dark-mode .pokemon-card:hover {
            background: #333;
        }

        .pokemon-image {
            width: 100%;
            height: 150px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .pokemon-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            text-transform: capitalize;
        }

        .pokemon-types {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .type-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
            text-transform: capitalize;
        }

        .pokemon-details {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        body.dark-mode .pokemon-details {
            background: #232323;
            color: #f0f0f0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        body.dark-mode .close-button {
            color: #bbb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-item span:first-child {
            font-weight: bold;
            color: #333;
        }

        .stat-item span:last-child {
            font-weight: 600;
            color: #2196F3;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #666;
        }

        /* Colores de tipos */
        .type-normal { background-color: #A8A878; }
        .type-fire { background-color: #F08030; }
        .type-water { background-color: #6890F0; }
        .type-electric { background-color: #F8D030; }
        .type-grass { background-color: #78C850; }
        .type-ice { background-color: #98D8D8; }
        .type-fighting { background-color: #C03028; }
        .type-poison { background-color: #A040A0; }
        .type-ground { background-color: #E0C068; }
        .type-flying { background-color: #A890F0; }
        .type-psychic { background-color: #F85888; }
        .type-bug { background-color: #A8B820; }
        .type-rock { background-color: #B8A038; }
        .type-ghost { background-color: #705898; }
        .type-dragon { background-color: #7038F8; }
        .type-dark { background-color: #705848; }
        .type-steel { background-color: #B8B8D0; }
        .type-fairy { background-color: #EE99AC; }

        .team-section {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 300px;
            background: white;
            padding: 20px;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }
        body.dark-mode .team-section {
            background: #232323;
            color: #f0f0f0;
            box-shadow: -2px 0 10px rgba(0,0,0,0.5);
        }

        .team-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 10px;
        }
        body.dark-mode .team-controls {
            background: #181818;
        }

        .team-controls button {
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        body.dark-mode .team-controls button {
            background-color: #294d29;
            color: #f0f0f0;
        }

        .team-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            overflow-y: auto;
        }

        .team-slot {
            background: #f5f5f5;
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.2s ease, background-color 0.3s, color 0.3s, border-color 0.3s;
            user-select: none;
        }
        body.dark-mode .team-slot {
            background: #232323;
            border-color: #444;
            color: #e0e0e0;
        }
        body.dark-mode .team-slot.filled {
            border-color: #6fcf97;
        }

        .team-slot img {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }

        .team-slot .pokemon-name {
            margin-top: 5px;
            font-size: 14px;
        }

        .pokemon-card.selected {
            border: 2px solid #4CAF50;
            background-color: #e8f5e9;
        }

        .remove-pokemon {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 14px;
            display: none;
        }
        body.dark-mode .remove-pokemon {
            background: #a22;
            color: #fff;
        }

        .team-slot.filled:hover .remove-pokemon {
            display: block;
        }

        .team-selector {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .team-selector select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .team-selector button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .team-selector button.delete {
            background-color: #f44336;
        }

        .battle-button {
            background-color: #FF9800;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .main-content {
            margin-left: 1vw; /*Espacio para el equipo */
        }

        .moves-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 2000;
        }
        body.dark-mode .moves-modal {
            background: #232323;
            color: #f0f0f0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .moves-modal.active {
            display: block;
        }

        .move-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f5f5f5;
            transition: all 0.2s ease;
            margin-bottom: 5px;
        }
        body.dark-mode .move-item {
            background: #232323;
            color: #f0f0f0;
            border-color: #444;
        }
        body.dark-mode .move-item.selected, body.dark-mode .move-item:hover {
            background: #294d29;
            border-color: #6fcf97;
        }

        .move-item .move-name {
            font-weight: bold;
            flex: 1;
        }

        .move-item .move-details {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .move-item .move-power {
            color: #666;
            font-size: 0.9em;
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .move-item .move-type {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            color: white;
            text-transform: capitalize;
        }

        .move-item .move-category {
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7em;
            color: white;
            text-transform: capitalize;
            margin-left: 5px;
        }

        .category-physical { background-color: #C03028; }
        .category-special { background-color: #6890F0; }
        .category-status { background-color: #A8A878; }

        .moves-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .moves-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .selected-moves {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        body.dark-mode .selected-moves {
            background: #181818;
            border-color: #444;
            color: #f0f0f0;
        }

        .selected-moves h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
        }

        .selected-move-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .selected-move-item .remove-move {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
        }

        .pokemon-stats-modal {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .pokemon-stats-modal img {
            width: 200px;
            height: 200px;
            object-fit: contain;
        }

        .hover-details {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            width: 300px;
            z-index: 1002;
            display: none;
            margin-top: 10px;
        }
        body.dark-mode .hover-details {
            background: #232323;
            color: #f0f0f0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .pokemon-card:hover .hover-details {
            display: block;
        }

        .theme-toggle {
            margin-right: 10px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .theme-toggle:hover {
            background-color: #45a049;
        }
        body.dark-mode .theme-toggle {
            background-color: #666;
        }
        body.dark-mode .theme-toggle:hover {
            background-color: #777;
        }

        body.dark-mode .selected-move-item {
            background: #181818;
            color: #f0f0f0;
            border-color: #444;
        }
        body.dark-mode .selected-move-item .move-type,
        body.dark-mode .selected-move-item .move-category {
            background: #333 !important;
            color: #f0f0f0 !important;
            border: none;
        }
        body.dark-mode .selected-move-item .move-power {
            background: #232323;
            color: #b0e0ff;
        }
    </style>
</head>
<body>
    <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
        <button class="theme-toggle" onclick="toggleDarkMode()">Cambiar Tema</button>
    </div>
    <div class="container main-content">
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Buscar Pok√©mon por nombre">
        </div>
        <div id="pokemonGrid" class="pokemon-grid"></div>
        <div id="loading" class="loading">Cargando Pok√©mon...</div>
    </div>

    <div class="team-section">
        <div class="team-controls">
        <div class="team-selector">
            <select id="teamSelector" onchange="changeTeam()">
            </select>
                <button onclick="createNewTeam()" title="Crear equipo"><i class="fa-solid fa-square-plus"></i></button>
                <button onclick="editTeamName()" title="Cambiar nombre"><i class="fa-solid fa-pen"></i></button>
                <button class="delete" onclick="deleteCurrentTeam()" title="Eliminar equipo"><i class="fa-solid fa-trash"></i></button>
        </div>
            <button class="battle-button" onclick="startBattle()">Iniciar Batalla</button>
            <button class="clear-team" onclick="clearTeam()">Limpiar Equipo</button>
        </div>
        <div class="team-grid" id="teamGrid">
            <!-- Los slots del equipo se generar√°n din√°micamente -->
        </div>
    </div>

    <div id="pokemonDetails" class="pokemon-details">
        <button class="close-button" onclick="closeDetails()">&times;</button>
        <div id="detailsContent"></div>
    </div>

    <div id="movesModal" class="moves-modal">
        <button class="close-button" onclick="closeMovesModal()">&times;</button>
        <div id="movesContent"></div>
        <button onclick="saveSelectedMoves()" style="margin-top: 15px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
            Guardar Movimientos
        </button>
    </div>

    <div id="teamNameModal" class="moves-modal">
        <button class="close-button" onclick="closeTeamNameModal()">&times;</button>
        <div style="padding: 20px;">
            <h3 id="teamNameModalTitle">Nuevo Equipo</h3>
            <input type="text" id="newTeamName" placeholder="Nombre del equipo" style="width: 100%; padding: 8px; margin: 10px 0;">
            <button onclick="confirmNewTeam()" style="margin-top: 15px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Crear Equipo
            </button>
        </div>
    </div>

    <script>
        let allPokemon = [];
        let searchTimeout;
        let teams = {};
        let currentTeam = null;
        let selectedPokemonForMoves = null;
        let selectedMoves = new Set();
        const typeTranslations = {
            'normal': 'Normal',
            'fire': 'Fuego',
            'water': 'Agua',
            'electric': 'El√©ctrico',
            'grass': 'Planta',
            'ice': 'Hielo',
            'fighting': 'Lucha',
            'poison': 'Veneno',
            'ground': 'Tierra',
            'flying': 'Volador',
            'psychic': 'Ps√≠quico',
            'bug': 'Bicho',
            'rock': 'Roca',
            'ghost': 'Fantasma',
            'dragon': 'Drag√≥n',
            'dark': 'Siniestro',
            'steel': 'Acero',
            'fairy': 'Hada'
        };

        // Inicializar slots del equipo
        function initializeTeamSlots() {
            const teamGrid = document.getElementById('teamGrid');
            teamGrid.innerHTML = '';
            for (let i = 0; i < 6; i++) {
                teamGrid.innerHTML += `
                    <div class="team-slot" data-slot="${i}" onclick="selectTeamSlot(${i})">
                        <div class="slot-placeholder">Slot ${i + 1}</div>
                    </div>
                `;
            }
        }

        // Funci√≥n para traducir tipos
        function translateType(type) {
            return typeTranslations[type.toLowerCase()] || type;
        }

        // Funci√≥n para renderizar un Pok√©mon
        function renderPokemon(pokemon) {
            const types = pokemon.types || [];
            const typeBadges = types.map(type => 
                `<span class="type-badge type-${type.toLowerCase()}">${translateType(type)}</span>`
            ).join('');

            const isSelected = currentTeam && teams[currentTeam] ? teams[currentTeam].includes(pokemon.id) : false;
            const selectedClass = isSelected ? 'selected' : '';

            // Buscar si el Pok√©mon est√° en alg√∫n equipo para mostrar sus movimientos espec√≠ficos
            let teamPokemonData = null;
            if (currentTeam && teams[currentTeam]) {
                for (const [teamName, team] of Object.entries(teams)) {
                    const index = team.indexOf(pokemon.id);
                    if (index !== -1) {
                        const pokemonHash = generatePokemonTeamHash(pokemon.id, teamName, index);
                        const savedData = localStorage.getItem(pokemonHash);
                        if (savedData) {
                            teamPokemonData = JSON.parse(savedData);
                            break;
                        }
                    }
                }
            }

            const displayData = teamPokemonData || {
                ...pokemon,
                health: pokemon.health || pokemon.maxHealth,
                maxHealth: pokemon.maxHealth,
                attack: pokemon.attack || pokemon.baseAttack,
                defense: pokemon.defense || pokemon.baseDefense,
                speed: pokemon.speed || pokemon.baseSpeed,
                specialAttack: pokemon.specialAttack || pokemon.baseSpecialAttack,
                specialDefense: pokemon.specialDefense || pokemon.baseSpecialDefense
            };

            return `
                <div class="pokemon-card ${selectedClass}" onclick="selectPokemon('${pokemon.id}')">
                    <img src="${pokemon.imageUrl}" alt="${pokemon.name}" class="pokemon-image" 
                         onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${pokemon.id}.png'">
                    <div class="pokemon-name">${pokemon.name.charAt(0).toUpperCase() + pokemon.name.slice(1)}</div>
                    <div class="pokemon-types">${typeBadges}</div>
                    <div class="hover-details">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span>HP:</span>
                                <span>${displayData.health || displayData.maxHealth}/${displayData.maxHealth}</span>
                            </div>
                            <div class="stat-item">
                                <span>Ataque:</span>
                                <span>${displayData.attack || displayData.baseAttack}</span>
                            </div>
                            <div class="stat-item">
                                <span>Defensa:</span>
                                <span>${displayData.defense || displayData.baseDefense}</span>
                            </div>
                            <div class="stat-item">
                                <span>Ataque Especial:</span>
                                <span>${displayData.specialAttack || displayData.baseSpecialAttack}</span>
                            </div>
                            <div class="stat-item">
                                <span>Defensa Especial:</span>
                                <span>${displayData.specialDefense || displayData.baseSpecialDefense}</span>
                            </div>
                            <div class="stat-item">
                                <span>Velocidad:</span>
                                <span>${displayData.speed || displayData.baseSpeed}</span>
                            </div>
                        </div>
                        <div class="moves-section">
                            <h4>Movimientos Seleccionados</h4>
                            <div class="selected-moves-list">
                                ${(displayData.selectedMoveIndices || []).map(index => {
                                    const move = displayData.moves[index];
                                    if (!move) return '';
                                    return `
                                        <div class="move-item">
                                            <span class="move-name">${move.name}</span>
                                            <div class="move-details">
                                                <span class="move-power">${move.power || 0} PWR</span>
                                                <span class="move-type type-${(move.type || 'normal').toLowerCase()}">${translateType(move.type || 'normal')}</span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Funci√≥n para seleccionar un Pok√©mon
        function selectPokemon(id) {
            if (!currentTeam) {
                alert('Primero debes crear o seleccionar un equipo');
                return;
            }

            const pokemon = allPokemon.find(p => p.id === id);
            if (!pokemon) return;

            // Si el equipo est√° lleno, mostramos un mensaje
            if (teams[currentTeam].filter(p => p !== null).length >= 6) {
                alert('El equipo est√° completo. Elimina un Pok√©mon antes de a√±adir otro.');
                return;
            }

            // Encontramos el primer slot vac√≠o
            const emptySlot = teams[currentTeam].findIndex(p => p === null);
            if (emptySlot !== -1) {
                addToTeam(id, emptySlot);
            }
        }

        // Funci√≥n para generar un hash √∫nico para un Pok√©mon en un equipo
        function generatePokemonTeamHash(pokemonId, teamName, slotIndex) {
            return `${teamName}_${pokemonId}_${slotIndex}`;
        }

        // Funci√≥n para obtener los datos de un Pok√©mon del equipo usando su hash
        function getTeamPokemonData(pokemonId, teamName, slotIndex) {
            const pokemonHash = generatePokemonTeamHash(pokemonId, teamName, slotIndex);
            const savedData = localStorage.getItem(pokemonHash);
            if (savedData) {
                return JSON.parse(savedData);
            }
            return null;
        }

        // Funci√≥n para guardar los datos de un Pok√©mon del equipo
        function saveTeamPokemonData(pokemonData, teamName, slotIndex) {
            const pokemonHash = generatePokemonTeamHash(pokemonData.id, teamName, slotIndex);
            localStorage.setItem(pokemonHash, JSON.stringify(pokemonData));
        }

        // Funci√≥n para a√±adir un Pok√©mon al equipo
        function addToTeam(id, slot = null) {
            const pokemon = allPokemon.find(p => p.id === id);
            if (!pokemon) return;

            if (slot === null) {
                slot = teams[currentTeam].findIndex(p => p === null);
            }

            if (slot === -1) {
                alert('El equipo est√° completo');
                return;
            }

            // Crear un hash √∫nico para este Pok√©mon en este equipo
            const pokemonHash = generatePokemonTeamHash(id, currentTeam, slot);
            
            // Crear una copia profunda de los datos del Pok√©mon con las estad√≠sticas correctamente inicializadas
            const pokemonData = {
                id: pokemon.id,
                name: pokemon.name,
                types: [...pokemon.types],
                health: pokemon.maxHealth,
                maxHealth: pokemon.maxHealth,
                attack: pokemon.attack || pokemon.baseAttack,
                defense: pokemon.defense || pokemon.baseDefense,
                speed: pokemon.speed || pokemon.baseSpeed,
                specialAttack: pokemon.specialAttack || pokemon.baseSpecialAttack,
                specialDefense: pokemon.specialDefense || pokemon.baseSpecialDefense,
                imageUrl: pokemon.imageUrl,
                moves: pokemon.moves.map(move => ({
                    name: move.name,
                    power: move.power,
                    type: move.type,
                    category: move.category
                })),
                selectedMoveIndices: [] // Inicializar sin movimientos seleccionados
            };

            // Guardar los datos del Pok√©mon en localStorage
            localStorage.setItem(pokemonHash, JSON.stringify(pokemonData));

            // A√±adir el ID del Pok√©mon al equipo
            teams[currentTeam][slot] = id;
            updateTeamDisplay();
            updatePokemonGrid();
            saveTeam(); // Guardar autom√°ticamente
        }

        function renderTeamSlot(pokemonId, index) {
            const slot = document.getElementById(`teamSlot${index}`);
            if (!slot) {
                console.warn(`Slot teamSlot${index} no encontrado.`);
                return;
            }
        }

        // Funci√≥n para eliminar un Pok√©mon del equipo
        function removeFromTeam(index) {
            const team = teams[currentTeam];
            if (team && team[index]) {
                // Eliminar los datos del Pok√©mon en el √≠ndice especificado
                const oldHash = generatePokemonTeamHash(team[index], currentTeam, index);
                localStorage.removeItem(oldHash);
                
                // Desplazar los Pok√©mon posteriores hacia atr√°s
                for (let i = index; i < team.length - 1; i++) {
                    if (team[i + 1]) {
                        // Guardar temporalmente los datos del Pok√©mon que se va a mover
                        const oldHash = generatePokemonTeamHash(team[i + 1], currentTeam, i + 1);
                        const pokemonData = localStorage.getItem(oldHash);
                        
                        // Eliminar los datos antiguos
                        localStorage.removeItem(oldHash);
                        
                        // Mover el Pok√©mon
                        team[i] = team[i + 1];
                        
                        // Guardar los datos en la nueva posici√≥n
                        if (pokemonData) {
                            const newHash = generatePokemonTeamHash(team[i], currentTeam, i);
                            localStorage.setItem(newHash, pokemonData);
                        }
                    } else {
                        team[i] = null;
                    }
                }
                
                // A√±adir un null al final para mantener el tama√±o del equipo
                team[team.length - 1] = null;
                
                updateTeamDisplay();
                saveTeam(); // Guardar autom√°ticamente
            }
        }

        // Funci√≥n para actualizar la visualizaci√≥n del equipo
        function updateTeamDisplay() {
            try {
                const teamSlots = document.querySelectorAll('.team-slot');
                teamSlots.forEach((slot, index) => {
                    const pokemonId = teams[currentTeam][index];
                    slot.dataset.slot = index;
                    
                    if (pokemonId) {
                        const pokemonHash = generatePokemonTeamHash(pokemonId, currentTeam, index);
                        const savedData = localStorage.getItem(pokemonHash);
                        const pokemonData = savedData ? JSON.parse(savedData) : allPokemon.find(p => p.id === pokemonId);
                        
                        if (pokemonData) {
                            slot.innerHTML = `
                                <img src="${pokemonData.imageUrl}" alt="${pokemonData.name}">
                                <div class="pokemon-name">${pokemonData.name.charAt(0).toUpperCase() + pokemonData.name.slice(1)}</div>
                                <button class="remove-pokemon" onclick="removeFromTeam(${index})">&times;</button>
                            `;
                            slot.classList.add('filled');
                            slot.onclick = () => showMovesModal(pokemonId, currentTeam, index);
                        } else {
                            teams[currentTeam][index] = null;
                            slot.innerHTML = `<div class="slot-placeholder">Slot ${index + 1}</div>`;
                            slot.classList.remove('filled');
                            slot.onclick = null;
                        }
                    } else {
                        slot.innerHTML = `<div class="slot-placeholder">Slot ${index + 1}</div>`;
                        slot.classList.remove('filled');
                        slot.onclick = null;
                    }
                });
            } catch (error) {
                console.error('Error al actualizar la visualizaci√≥n del equipo:', error);
            }
        }

        // Funci√≥n para actualizar la cuadr√≠cula de Pok√©mon
        function updatePokemonGrid() {
            try {
                const grid = document.getElementById('pokemonGrid');
                if (allPokemon && allPokemon.length > 0) {
                    grid.innerHTML = allPokemon.map(renderPokemon).join('');
                }
            } catch (error) {
                console.error('Error al actualizar la cuadr√≠cula de Pok√©mon:', error);
            }
        }

        // Funci√≥n para guardar el equipo
        async function saveTeam() {
            try {
                const allTeams = {};
                for (const [teamName, team] of Object.entries(teams)) {
                    const teamData = team.filter(id => id !== null).map((id, index) => {
                        const pokemonData = getTeamPokemonData(id, teamName, index);
                        if (!pokemonData) return null;
                        
                        // Guardar los datos del Pok√©mon usando su hash
                        saveTeamPokemonData(pokemonData, teamName, index);
                        
                        // Devolver el hash para el equipo
                        return generatePokemonTeamHash(id, teamName, index);
                    }).filter(p => p !== null);

                    if (teamData.length > 0) {
                        allTeams[teamName] = teamData;
                    }
                }

                // Guardar los equipos en localStorage
                const teamsJson = JSON.stringify(allTeams);
                localStorage.setItem('pokemonTeams', teamsJson);
                
                // Verificar que se guard√≥ correctamente
                const savedTeams = localStorage.getItem('pokemonTeams');
                if (savedTeams === teamsJson) {
                } else {
                    throw new Error('Error al verificar el guardado');
                }
            } catch (error) {
                console.error('Error al guardar los equipos:', error);
                alert('Error al guardar los equipos. Por favor, intenta de nuevo.');
            }
        }

        // Funci√≥n para limpiar el equipo
        function clearTeam() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar este equipo?')) {
                teams[currentTeam] = new Array(6).fill(null);
                updateTeamDisplay();
                updatePokemonGrid();
                saveTeam(); // Guardar autom√°ticamente
            }
        }

        // Funci√≥n para cargar el equipo guardado
        function loadSavedTeam() {
            try {
                const savedTeams = localStorage.getItem('pokemonTeams');
                if (savedTeams) {
                    const loadedTeams = JSON.parse(savedTeams);
                    
                    for (const [teamName, teamHashes] of Object.entries(loadedTeams)) {
                        teams[teamName] = new Array(6).fill(null);
                        const selector = document.getElementById('teamSelector');
                        const option = document.createElement('option');
                        option.value = teamName;
                        option.textContent = teamName;
                        selector.appendChild(option);
                        
                        teamHashes.forEach((pokemonHash, index) => {
                            if (index < 6) {
                                // Extraer el ID del Pok√©mon del hash
                                const [_, pokemonId] = pokemonHash.split('_');
                                teams[teamName][index] = pokemonId;
                            }
                        });
                    }
                    
                    // Si hay equipos cargados, seleccionar el primero
                    if (Object.keys(teams).length > 0) {
                        currentTeam = Object.keys(teams)[0];
                        document.getElementById('teamSelector').value = currentTeam;
                    }
                    
                    updateTeamDisplay();
                    updatePokemonGrid();
                }
            } catch (error) {
                console.error('Error al cargar los equipos guardados:', error);
                localStorage.removeItem('pokemonTeams');
            }
        }

        // Funci√≥n para cargar Pok√©mon
        async function loadPokemon() {
            try {
                const response = await fetch('/api/pokemon');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const pokemon = await response.json();
                allPokemon = pokemon;
                
                const grid = document.getElementById('pokemonGrid');
                grid.innerHTML = pokemon.map(renderPokemon).join('');
                
                document.getElementById('loading').style.display = 'none';
                
                // Cargar el equipo guardado despu√©s de cargar los Pok√©mon
                loadSavedTeam();

                // Iniciar la carga progresiva
                startProgressiveLoading();
            } catch (error) {
                console.error('Error al cargar Pok√©mon:', error);
                document.getElementById('loading').textContent = 'Error al cargar Pok√©mon. Por favor, recarga la p√°gina.';
            }
        }

        // Funci√≥n para cargar m√°s Pok√©mon progresivamente
        async function startProgressiveLoading() {
            const loadingElement = document.getElementById('loading');
            loadingElement.style.display = 'block';
            loadingElement.textContent = 'Cargando m√°s Pok√©mon...';

            try {
                const response = await fetch('/api/pokemon/load-more');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                if (data.pokemon && data.pokemon.length > 0) {
                    // Actualizar la lista de Pok√©mon
                    allPokemon = data.pokemon;
                    
                    // Actualizar la cuadr√≠cula
                    const grid = document.getElementById('pokemonGrid');
                    grid.innerHTML = data.pokemon.map(renderPokemon).join('');
                    
                    // Si hay m√°s Pok√©mon por cargar, continuar
                    if (data.hasMore) {
                        setTimeout(startProgressiveLoading, 1000);
                    } else {
                        loadingElement.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error al cargar m√°s Pok√©mon:', error);
                loadingElement.textContent = 'Error al cargar m√°s Pok√©mon. Intenta recargar la p√°gina.';
            }
        }

        // Funci√≥n para buscar Pok√©mon
        function searchPokemon(query) {
            if (!query) {
                document.getElementById('pokemonGrid').innerHTML = allPokemon.map(renderPokemon).join('');
                return;
            }

            const filteredPokemon = allPokemon.filter(pokemon => 
                pokemon.name.toLowerCase().includes(query.toLowerCase()) ||
                (pokemon.types || []).some(type => type.toLowerCase().includes(query.toLowerCase()))
            );

            document.getElementById('pokemonGrid').innerHTML = filteredPokemon.map(renderPokemon).join('');
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => searchPokemon(e.target.value), 300);
        });

        // Inicializaci√≥n
        initializeTeamSlots();
        loadPokemon();

        // Cerrar detalles al hacer clic fuera
        document.addEventListener('click', (e) => {
            const details = document.getElementById('pokemonDetails');
            if (e.target === details) {
                closeDetails();
            }
        });

        // Funci√≥n para cambiar de equipo
        function changeTeam() {
            const newTeam = document.getElementById('teamSelector').value;
            if (newTeam) {
                currentTeam = newTeam;
                updateTeamDisplay();
                updatePokemonGrid();
            }
        }

        // Funci√≥n para crear un nuevo equipo
        function createNewTeam() {
            document.getElementById('teamNameModalTitle').textContent = 'Nuevo Equipo';
            document.getElementById('teamNameModal').classList.add('active');
            document.getElementById('newTeamName').value = '';
            document.getElementById('newTeamName').focus();
            saveTeam();
        }

        function editTeamName() {
            const currentName = document.getElementById('teamSelector').value;
            document.getElementById('teamNameModalTitle').textContent = 'Editar Nombre del Equipo';
            document.getElementById('teamNameModal').classList.add('active');
            document.getElementById('newTeamName').value = currentName;
            document.getElementById('newTeamName').focus();
            saveTeam();
        }

        function closeTeamNameModal() {
            document.getElementById('teamNameModal').classList.remove('active');
        }

        function confirmNewTeam() {
            const teamName = document.getElementById('newTeamName').value.trim();
            const isEditing = document.getElementById('teamNameModalTitle').textContent === 'Editar Nombre del Equipo';
            const oldTeamName = document.getElementById('teamSelector').value;
            
            if (!teamName) {
                alert('Por favor, ingresa un nombre para el equipo');
                return;
            }

            // Si estamos editando y el nombre no cambi√≥, solo cerramos el modal
            if (isEditing && teamName === oldTeamName) {
                closeTeamNameModal();
                return;
            }

            // Verificar si el nombre ya existe (excepto si estamos editando el mismo equipo)
            if (teams[teamName] && (!isEditing || teamName !== oldTeamName)) {
                alert('Ya existe un equipo con ese nombre');
                return;
            }

            if (isEditing) {
                // Si estamos editando, necesitamos mover los datos del equipo
                teams[teamName] = teams[oldTeamName];
                
                // Actualizar las referencias en localStorage para cada Pok√©mon del equipo
                teams[oldTeamName].forEach((pokemonId, index) => {
                    if (pokemonId) {
                        const oldHash = generatePokemonTeamHash(pokemonId, oldTeamName, index);
                        const newHash = generatePokemonTeamHash(pokemonId, teamName, index);
                        const pokemonData = localStorage.getItem(oldHash);
                        if (pokemonData) {
                            localStorage.setItem(newHash, pokemonData);
                            localStorage.removeItem(oldHash);
                        }
                    }
                });

                delete teams[oldTeamName];

                // Actualizar el selector
                const selector = document.getElementById('teamSelector');
                const option = selector.options[selector.selectedIndex];
                option.value = teamName;
                option.textContent = teamName;
                
                currentTeam = teamName;
            } else {
                // Crear un nuevo equipo
                teams[teamName] = new Array(6).fill(null);
                
                const selector = document.getElementById('teamSelector');
                const option = document.createElement('option');
                option.value = teamName;
                option.textContent = teamName;
                selector.appendChild(option);
                selector.value = teamName;
                
                currentTeam = teamName;
            }

            closeTeamNameModal();
            updateTeamDisplay();
            updatePokemonGrid();

            // Guardar inmediatamente el equipo en localStorage
            const allTeams = {};
            for (const [teamName, team] of Object.entries(teams)) {
                const teamData = team.filter(id => id !== null).map((id, index) => {
                    const pokemonData = getTeamPokemonData(id, teamName, index);
                    if (!pokemonData) return null;
                    return generatePokemonTeamHash(id, teamName, index);
                }).filter(p => p !== null);

                if (teamData.length > 0) {
                    allTeams[teamName] = teamData;
                } else {
                    // Incluir equipos vac√≠os
                    allTeams[teamName] = [];
                }
            }

            localStorage.setItem('pokemonTeams', JSON.stringify(allTeams));
        }

        // Funci√≥n para eliminar el equipo actual
        function deleteCurrentTeam() {
            if (Object.keys(teams).length <= 1) {
                alert('Debe haber al menos un equipo');
                return;
            }

            if (confirm('¬øEst√°s seguro de que quieres eliminar este equipo?')) {
                const selector = document.getElementById('teamSelector');
                const option = selector.options[selector.selectedIndex];
                selector.removeChild(option);
                delete teams[currentTeam];
                
                // Seleccionar otro equipo disponible
                const remainingTeams = Object.keys(teams);
                if (remainingTeams.length > 0) {
                    currentTeam = remainingTeams[0];
                    selector.value = currentTeam;
                } else {
                    currentTeam = null;
                }
                
                updateTeamDisplay();
                updatePokemonGrid();
                saveTeam();
            }
        }

        // Funci√≥n para iniciar la batalla
        function startBattle() {
            const validTeams = Object.entries(teams).filter(([_, team]) => 
                team.some(id => id !== null)
            );

            if (validTeams.length < 2) {
                alert('Necesitas al menos dos equipos con Pok√©mon para iniciar una batalla');
                return;
            }

            const team1 = validTeams[0][1].filter(id => id !== null);
            const team2 = validTeams[1][1].filter(id => id !== null);

            // Preparar datos de los equipos
            const battleTeams = {
                team1: team1.map(id => {
                    const pokemon = allPokemon.find(p => p.id === id);
                    return {
                        id: pokemon.id,
                        name: pokemon.name,
                        types: pokemon.types,
                        health: pokemon.health,
                        maxHealth: pokemon.maxHealth,
                        attack: pokemon.attack,
                        defense: pokemon.defense,
                        speed: pokemon.speed,
                        specialAttack: pokemon.specialAttack,
                        specialDefense: pokemon.specialDefense,
                        imageUrl: pokemon.imageUrl,
                        moves: pokemon.moves,
                        selectedMoveIndices: pokemon.selectedMoveIndices || [0, 1, 2, 3]
                    };
                }),
                team2: team2.map(id => {
                    const pokemon = allPokemon.find(p => p.id === id);
                    return {
                        id: pokemon.id,
                        name: pokemon.name,
                        types: pokemon.types,
                        health: pokemon.health,
                        maxHealth: pokemon.maxHealth,
                        attack: pokemon.attack,
                        defense: pokemon.defense,
                        speed: pokemon.speed,
                        specialAttack: pokemon.specialAttack,
                        specialDefense: pokemon.specialDefense,
                        imageUrl: pokemon.imageUrl,
                        moves: pokemon.moves,
                        selectedMoveIndices: pokemon.selectedMoveIndices || [0, 1, 2, 3]
                    };
                })
            };

            // Guardar datos de la batalla
            localStorage.setItem('battleTeams', JSON.stringify(battleTeams));

            // Redirigir a la p√°gina de batalla
            window.location.href = 'battle.html';
        }

        function showMovesModal(pokemonId, teamName, slotIndex) {
            const pokemonData = getTeamPokemonData(pokemonId, teamName, slotIndex);
            if (!pokemonData) return;

            console.log('Mostrando modal para:', {
                pokemon: pokemonData.name,
                team: teamName,
                slot: slotIndex,
                hash: generatePokemonTeamHash(pokemonId, teamName, slotIndex)
            });

            selectedPokemonForMoves = {
                ...pokemonData,
                teamName: teamName,
                slotIndex: slotIndex
            };
            selectedMoves = new Set();

            // Si hay movimientos seleccionados previamente, marcarlos
            if (pokemonData.selectedMoveIndices && pokemonData.selectedMoveIndices.length > 0) {
                pokemonData.selectedMoveIndices.forEach(index => {
                    if (pokemonData.moves && pokemonData.moves[index]) {
                        selectedMoves.add(index.toString());
                    }
                });
            }

            const movesContent = document.getElementById('movesContent');
            movesContent.innerHTML = `
                <div class="pokemon-stats-modal">
                    <div>
                        <img src="${pokemonData.imageUrl}" alt="${pokemonData.name}">
                        <h3>${pokemonData.name}</h3>
                        <div class="pokemon-types">
                            ${pokemonData.types.map(type => 
                                `<span class="type-badge type-${type.toLowerCase()}">${translateType(type)}</span>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span>HP:</span>
                            <span>${pokemonData.health}/${pokemonData.maxHealth}</span>
                        </div>
                        <div class="stat-item">
                            <span>Ataque:</span>
                            <span>${pokemonData.attack}</span>
                        </div>
                        <div class="stat-item">
                            <span>Defensa:</span>
                            <span>${pokemonData.defense}</span>
                        </div>
                        <div class="stat-item">
                            <span>Ataque Especial:</span>
                            <span>${pokemonData.specialAttack}</span>
                        </div>
                        <div class="stat-item">
                            <span>Defensa Especial:</span>
                            <span>${pokemonData.specialDefense}</span>
                        </div>
                        <div class="stat-item">
                            <span>Velocidad:</span>
                            <span>${pokemonData.speed}</span>
                        </div>
                    </div>
                </div>
                <div class="moves-container">
                    <div>
                        <h3>Lista de Movimientos Disponibles</h3>
                        <div class="moves-list">
                            ${pokemonData.moves.map((move, index) => {
                                const categoryClass = `category-${(move.category || 'status').toLowerCase()}`;
                                const isSelected = selectedMoves.has(index.toString());
                                return `
                                    <div class="move-item ${isSelected ? 'selected' : ''}" 
                                         onclick="toggleMove(${index})">
                                        <span class="move-name">${move.name}</span>
                                        <div class="move-details">
                                            <span class="move-power">${move.power || 0} PWR</span>
                                            <span class="move-type type-${(move.type || 'normal').toLowerCase()}">${translateType(move.type || 'normal')}</span>
                                            <span class="move-category ${categoryClass}">${move.category || 'status'}</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    <div class="selected-moves">
                        <h4>Movimientos Seleccionados (${selectedMoves.size}/4)</h4>
                        <div id="selectedMovesList"></div>
                    </div>
                </div>
            `;

            const modal = document.getElementById('movesModal');
            modal.classList.add('active');
            updateSelectedMovesList();
        }

        function toggleMove(index) {
            const indexStr = index.toString();
            const moveItems = document.querySelectorAll('.move-item');
            const moveItem = moveItems[index];
            
            if (!moveItem) return;

            if (selectedMoves.has(indexStr)) {
                selectedMoves.delete(indexStr);
                moveItem.classList.remove('selected');
            } else if (selectedMoves.size < 4) {
                selectedMoves.add(indexStr);
                moveItem.classList.add('selected');
            } else {
                alert('Solo puedes seleccionar 4 movimientos');
                return;
            }

            updateSelectedMovesList();
            updateMovesList();
        }

        function updateMovesList() {
            const movesList = document.querySelector('.moves-list');
            if (!movesList || !selectedPokemonForMoves) return;

            movesList.innerHTML = selectedPokemonForMoves.moves.map((move, index) => {
                const categoryClass = `category-${(move.category || 'status').toLowerCase()}`;
                const isSelected = selectedMoves.has(index.toString());
                return `
                    <div class="move-item ${isSelected ? 'selected' : ''}" 
                         onclick="toggleMove(${index})">
                        <span class="move-name">${move.name}</span>
                        <div class="move-details">
                            <span class="move-power">${move.power || 0} PWR</span>
                            <span class="move-type type-${(move.type || 'normal').toLowerCase()}">${translateType(move.type || 'normal')}</span>
                            <span class="move-category ${categoryClass}">${move.category || 'status'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateSelectedMovesList() {
            const selectedMovesList = document.getElementById('selectedMovesList');
            if (!selectedMovesList) return;

            const moves = Array.from(selectedMoves).map(indexStr => {
                const index = parseInt(indexStr);
                const move = selectedPokemonForMoves.moves[index];
                console.log('Actualizando movimiento seleccionado:', move, 'en √≠ndice', index);
                return `
                    <div class="selected-move-item">
                        <span class="move-name">${move.name}</span>
                        <div class="move-details">
                            <span class="move-power">${move.power || 0} PWR</span>
                            <span class="move-type type-${(move.type || 'normal').toLowerCase()}">${translateType(move.type || 'normal')}</span>
                            <span class="move-category category-${(move.category || 'status').toLowerCase()}">${move.category || 'status'}</span>
                            <button class="remove-move" onclick="removeMove(${index})">&times;</button>
                        </div>
                    </div>
                `;
            }).join('');

            selectedMovesList.innerHTML = moves || '<p>No hay movimientos seleccionados</p>';
            
            // Actualizar el contador
            const counter = document.querySelector('.selected-moves h4');
            if (counter) {
                counter.textContent = `Movimientos Seleccionados (${selectedMoves.size}/4)`;
            }
        }

        function removeMove(index) {
            const indexStr = index.toString();
            selectedMoves.delete(indexStr);
            
            // Actualizar la UI de la lista de movimientos
            const moveItems = document.querySelectorAll('.move-item');
            const moveItem = moveItems[index];
            if (moveItem) {
                moveItem.classList.remove('selected');
            }
            
            updateSelectedMovesList();
            updateMovesList();
        }

        function saveSelectedMoves() {
            if (!selectedPokemonForMoves) return;

            if (selectedMoves.size === 0) {
                alert('Debes seleccionar al menos un movimiento');
                return;
            }

            // Convertir los √≠ndices de string a n√∫mero
            const selectedMoveIndices = Array.from(selectedMoves).map(indexStr => parseInt(indexStr));

            // Crear una copia de los datos del Pok√©mon
            const updatedPokemonData = {
                ...selectedPokemonForMoves,
                selectedMoveIndices: selectedMoveIndices
            };

            // Guardar los datos actualizados usando el hash espec√≠fico de esta instancia
            saveTeamPokemonData(
                updatedPokemonData,
                selectedPokemonForMoves.teamName,
                selectedPokemonForMoves.slotIndex
            );
            
            closeMovesModal();
            updateTeamDisplay();
            updatePokemonGrid();
            saveTeam(); // Guardar autom√°ticamente
        }

        function closeMovesModal() {
            document.getElementById('movesModal').classList.remove('active');
            selectedPokemonForMoves = null;
            selectedMoves.clear();
        }

        // Modo oscuro
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }
        // Cargar preferencia de tema al iniciar
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
            }
        });
    </script>
</body>
</html> 