<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokédex</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .search-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .search-bar input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }

        .pokemon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .pokemon-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .pokemon-card:hover {
            transform: translateY(-5px);
        }

        .pokemon-image {
            width: 100%;
            height: 150px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .pokemon-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            text-transform: capitalize;
        }

        .pokemon-types {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .type-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
            text-transform: capitalize;
        }

        .pokemon-details {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            display: none;
        }

        .pokemon-details.active {
            display: block;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #666;
        }

        /* Colores de tipos */
        .type-normal { background-color: #A8A878; }
        .type-fire { background-color: #F08030; }
        .type-water { background-color: #6890F0; }
        .type-electric { background-color: #F8D030; }
        .type-grass { background-color: #78C850; }
        .type-ice { background-color: #98D8D8; }
        .type-fighting { background-color: #C03028; }
        .type-poison { background-color: #A040A0; }
        .type-ground { background-color: #E0C068; }
        .type-flying { background-color: #A890F0; }
        .type-psychic { background-color: #F85888; }
        .type-bug { background-color: #A8B820; }
        .type-rock { background-color: #B8A038; }
        .type-ghost { background-color: #705898; }
        .type-dragon { background-color: #7038F8; }
        .type-dark { background-color: #705848; }
        .type-steel { background-color: #B8B8D0; }
        .type-fairy { background-color: #EE99AC; }

        .team-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .team-slot {
            background: #f5f5f5;
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .team-slot.filled {
            border-style: solid;
            border-color: #4CAF50;
        }

        .team-slot img {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }

        .team-slot .pokemon-name {
            margin-top: 5px;
            font-size: 14px;
        }

        .pokemon-card.selected {
            border: 2px solid #4CAF50;
            background-color: #e8f5e9;
        }

        .remove-pokemon {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 14px;
            display: none;
        }

        .team-slot.filled:hover .remove-pokemon {
            display: block;
        }

        .team-controls {
            text-align: center;
            margin-top: 10px;
        }

        .team-controls button {
            padding: 10px 20px;
            margin: 0 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .team-selector {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .team-selector select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .team-selector button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .team-selector button.delete {
            background-color: #f44336;
        }

        .battle-button {
            background-color: #FF9800;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .main-content {
            margin-bottom: 200px; /* Espacio para el equipo */
        }
    </style>
</head>
<body>
    <div class="container main-content">
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Buscar Pokémon por nombre o tipo...">
        </div>
        <div id="pokemonGrid" class="pokemon-grid"></div>
        <div id="loading" class="loading">Cargando Pokémon...</div>
    </div>

    <div class="team-section">
        <div class="team-selector">
            <select id="teamSelector" onchange="changeTeam()">
                <option value="team1">Equipo 1</option>
                <option value="team2">Equipo 2</option>
            </select>
            <button onclick="createNewTeam()">Nuevo Equipo</button>
            <button class="delete" onclick="deleteCurrentTeam()">Eliminar Equipo</button>
        </div>
        <div class="team-grid" id="teamGrid">
            <!-- Los slots del equipo se generarán dinámicamente -->
        </div>
        <div class="team-controls">
            <button class="save-team" onclick="saveTeam()">Guardar Equipo</button>
            <button class="clear-team" onclick="clearTeam()">Limpiar Equipo</button>
            <button class="battle-button" onclick="startBattle()">Iniciar Batalla</button>
        </div>
    </div>

    <div id="pokemonDetails" class="pokemon-details">
        <button class="close-button" onclick="closeDetails()">&times;</button>
        <div id="detailsContent"></div>
    </div>

    <script>
        let allPokemon = [];
        let searchTimeout;
        let teams = {
            team1: new Array(6).fill(null),
            team2: new Array(6).fill(null)
        };
        let currentTeam = 'team1';
        let teamCounter = 2;
        const typeTranslations = {
            'normal': 'Normal',
            'fire': 'Fuego',
            'water': 'Agua',
            'electric': 'Eléctrico',
            'grass': 'Planta',
            'ice': 'Hielo',
            'fighting': 'Lucha',
            'poison': 'Veneno',
            'ground': 'Tierra',
            'flying': 'Volador',
            'psychic': 'Psíquico',
            'bug': 'Bicho',
            'rock': 'Roca',
            'ghost': 'Fantasma',
            'dragon': 'Dragón',
            'dark': 'Siniestro',
            'steel': 'Acero',
            'fairy': 'Hada'
        };

        // Inicializar slots del equipo
        function initializeTeamSlots() {
            const teamGrid = document.getElementById('teamGrid');
            teamGrid.innerHTML = '';
            for (let i = 0; i < 6; i++) {
                teamGrid.innerHTML += `
                    <div class="team-slot" data-slot="${i}" onclick="selectTeamSlot(${i})">
                        <div class="slot-placeholder">Slot ${i + 1}</div>
                    </div>
                `;
            }
        }

        // Función para traducir tipos
        function translateType(type) {
            return typeTranslations[type.toLowerCase()] || type;
        }

        // Función para renderizar un Pokémon
        function renderPokemon(pokemon) {
            const types = pokemon.types || [];
            const typeBadges = types.map(type => 
                `<span class="type-badge type-${type.toLowerCase()}">${translateType(type)}</span>`
            ).join('');

            const isSelected = teams[currentTeam].includes(pokemon.id);
            const selectedClass = isSelected ? 'selected' : '';

            return `
                <div class="pokemon-card ${selectedClass}" onclick="selectPokemon('${pokemon.id}')">
                    <img src="${pokemon.imageUrl}" alt="${pokemon.name}" class="pokemon-image">
                    <div class="pokemon-name">${pokemon.name.charAt(0).toUpperCase() + pokemon.name.slice(1)}</div>
                    <div class="pokemon-types">${typeBadges}</div>
                </div>
            `;
        }

        // Función para mostrar detalles
        function showDetails(id) {
            const pokemon = allPokemon.find(p => p.id === id);
            if (!pokemon) return;

            const types = pokemon.types || [];
            const typeBadges = types.map(type => 
                `<span class="type-badge type-${type.toLowerCase()}">${translateType(type)}</span>`
            ).join('');

            const detailsContent = `
                <img src="${pokemon.imageUrl}" alt="${pokemon.name}" style="width: 200px; height: 200px; object-fit: contain;">
                <h2>${pokemon.name.charAt(0).toUpperCase() + pokemon.name.slice(1)}</h2>
                <div class="pokemon-types">${typeBadges}</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span>HP:</span>
                        <span>${pokemon.health}/${pokemon.maxHealth}</span>
                    </div>
                    <div class="stat-item">
                        <span>Ataque:</span>
                        <span>${pokemon.attack}</span>
                    </div>
                    <div class="stat-item">
                        <span>Defensa:</span>
                        <span>${pokemon.defense}</span>
                    </div>
                    <div class="stat-item">
                        <span>Ataque Especial:</span>
                        <span>${pokemon.specialAttack}</span>
                    </div>
                    <div class="stat-item">
                        <span>Defensa Especial:</span>
                        <span>${pokemon.specialDefense}</span>
                    </div>
                    <div class="stat-item">
                        <span>Velocidad:</span>
                        <span>${pokemon.speed}</span>
                    </div>
                </div>
                </div>
                <button onclick="addToTeam('${pokemon.id}')" style="margin-top: 15px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Añadir al Equipo
                </button>
            `;

            document.getElementById('detailsContent').innerHTML = detailsContent;
            document.getElementById('pokemonDetails').classList.add('active');
        }

        // Función para seleccionar un Pokémon
        function selectPokemon(id) {
            const pokemon = allPokemon.find(p => p.id === id);
            if (!pokemon) return;

            // Si el Pokémon ya está en el equipo, lo removemos
            const currentIndex = teams[currentTeam].indexOf(id);
            if (currentIndex !== -1) {
                removeFromTeam(currentIndex);
                return;
            }

            // Si el equipo está lleno, mostramos un mensaje
            if (teams[currentTeam].filter(p => p !== null).length >= 6) {
                alert('El equipo está completo. Elimina un Pokémon antes de añadir otro.');
                return;
            }

            // Encontramos el primer slot vacío
            const emptySlot = teams[currentTeam].findIndex(p => p === null);
            if (emptySlot !== -1) {
                addToTeam(id, emptySlot);
            }
        }

        // Función para añadir un Pokémon al equipo
        function addToTeam(id, slot = null) {
            const pokemon = allPokemon.find(p => p.id === id);
            if (!pokemon) return;

            if (slot === null) {
                slot = teams[currentTeam].findIndex(p => p === null);
            }

            if (slot === -1) {
                alert('El equipo está completo');
                return;
            }

            teams[currentTeam][slot] = id;
            updateTeamDisplay();
            updatePokemonGrid();
        }

        // Función para remover un Pokémon del equipo
        function removeFromTeam(slot) {
            teams[currentTeam][slot] = null;
            updateTeamDisplay();
            updatePokemonGrid();
        }

        // Función para actualizar la visualización del equipo
        function updateTeamDisplay() {
            try {
                const teamSlots = document.querySelectorAll('.team-slot');
                teamSlots.forEach((slot, index) => {
                    const pokemonId = teams[currentTeam][index];
                    if (pokemonId) {
                        const pokemon = allPokemon.find(p => p.id === pokemonId);
                        if (pokemon) {
                            slot.innerHTML = `
                                <img src="${pokemon.imageUrl}" alt="${pokemon.name}">
                                <div class="pokemon-name">${pokemon.name.charAt(0).toUpperCase() + pokemon.name.slice(1)}</div>
                                <button class="remove-pokemon" onclick="removeFromTeam(${index})">&times;</button>
                            `;
                            slot.classList.add('filled');
                        } else {
                            teams[currentTeam][index] = null;
                            slot.innerHTML = `<div class="slot-placeholder">Slot ${index + 1}</div>`;
                            slot.classList.remove('filled');
                        }
                    } else {
                        slot.innerHTML = `<div class="slot-placeholder">Slot ${index + 1}</div>`;
                        slot.classList.remove('filled');
                    }
                });
            } catch (error) {
                console.error('Error al actualizar la visualización del equipo:', error);
            }
        }

        // Función para actualizar la cuadrícula de Pokémon
        function updatePokemonGrid() {
            try {
                const grid = document.getElementById('pokemonGrid');
                if (allPokemon && allPokemon.length > 0) {
                    grid.innerHTML = allPokemon.map(renderPokemon).join('');
                }
            } catch (error) {
                console.error('Error al actualizar la cuadrícula de Pokémon:', error);
            }
        }

        // Función para generar un hash simple
        function generateHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(36);
        }

        // Función para guardar el equipo
        async function saveTeam() {
            try {
                const allTeams = {};
                for (const [teamName, team] of Object.entries(teams)) {
                    const teamData = team.filter(id => id !== null).map(id => {
                        const pokemon = allPokemon.find(p => p.id === id);
                        if (!pokemon) return null;
                        
                        // Asegurarnos de que todos los datos necesarios estén presentes
                        const pokemonData = {
                            id: pokemon.id,
                            name: pokemon.name,
                            types: pokemon.types || [],
                            health: pokemon.maxHealth,
                            maxHealth: pokemon.maxHealth,
                            attack: pokemon.attack,
                            defense: pokemon.defense,
                            speed: pokemon.speed,
                            specialAttack: pokemon.specialAttack,
                            specialDefense: pokemon.specialDefense,
                            imageUrl: pokemon.imageUrl,
                            moves: pokemon.moves || []
                        };

                        // Verificar que los movimientos estén presentes y sean válidos
                        if (!pokemonData.moves || pokemonData.moves.length === 0) {
                            console.warn(`No se encontraron movimientos para ${pokemon.name}`);
                            // Añadir movimientos por defecto si no hay ninguno
                            pokemonData.moves = [
                                { name: "Ataque Rápido", power: 40, type: "normal" },
                                { name: "Placaje", power: 35, type: "normal" },
                                { name: "Arañazo", power: 30, type: "normal" },
                                { name: "Destructor", power: 45, type: "normal" }
                            ];
                        }

                        // Asegurarnos de que solo haya 4 movimientos
                        if (pokemonData.moves.length > 4) {
                            pokemonData.moves = pokemonData.moves.slice(0, 4);
                        }

                        console.log('Guardando Pokémon:', pokemonData);
                        return pokemonData;
                    }).filter(p => p !== null);

                    if (teamData.length > 0) {
                        allTeams[teamName] = teamData;
                    }
                }

                console.log('Guardando equipos:', allTeams);
                localStorage.setItem('pokemonTeams', JSON.stringify(allTeams));
                alert('Equipos guardados correctamente');
            } catch (error) {
                console.error('Error al guardar los equipos:', error);
                alert('Error al guardar los equipos. Por favor, intenta de nuevo.');
            }
        }

        // Función para limpiar el equipo
        function clearTeam() {
            if (confirm('¿Estás seguro de que quieres limpiar este equipo?')) {
                teams[currentTeam] = new Array(6).fill(null);
                updateTeamDisplay();
                updatePokemonGrid();
            }
        }

        // Función para cargar el equipo guardado
        function loadSavedTeam() {
            try {
                const savedTeams = localStorage.getItem('pokemonTeams');
                if (savedTeams) {
                    const loadedTeams = JSON.parse(savedTeams);
                    console.log('Equipos cargados:', loadedTeams); // Debug
                    
                    for (const [teamName, team] of Object.entries(loadedTeams)) {
                        if (!teams[teamName]) {
                            teams[teamName] = new Array(6).fill(null);
                            const selector = document.getElementById('teamSelector');
                            const option = document.createElement('option');
                            option.value = teamName;
                            option.textContent = teamName.charAt(0).toUpperCase() + teamName.slice(1);
                            selector.appendChild(option);
                        }
                        
                    team.forEach((pokemon, index) => {
                            if (index < 6 && pokemon) {
                                teams[teamName][index] = pokemon.id;
                        }
                    });
                    }
                    updateTeamDisplay();
                    updatePokemonGrid();
                }
            } catch (error) {
                console.error('Error al cargar los equipos guardados:', error);
                localStorage.removeItem('pokemonTeams');
            }
        }

        // Función para cargar Pokémon
        async function loadPokemon() {
            try {
                const response = await fetch('/api/pokemon');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const pokemon = await response.json();
                allPokemon = pokemon;
                
                const grid = document.getElementById('pokemonGrid');
                grid.innerHTML = pokemon.map(renderPokemon).join('');
                
                document.getElementById('loading').style.display = 'none';
                
                // Cargar el equipo guardado después de cargar los Pokémon
                loadSavedTeam();
            } catch (error) {
                console.error('Error al cargar Pokémon:', error);
                document.getElementById('loading').textContent = 'Error al cargar Pokémon. Por favor, recarga la página.';
            }
        }

        // Función para buscar Pokémon
        function searchPokemon(query) {
            if (!query) {
                document.getElementById('pokemonGrid').innerHTML = allPokemon.map(renderPokemon).join('');
                return;
            }

            const filteredPokemon = allPokemon.filter(pokemon => 
                pokemon.name.toLowerCase().includes(query.toLowerCase()) ||
                (pokemon.types || []).some(type => type.toLowerCase().includes(query.toLowerCase()))
            );

            document.getElementById('pokemonGrid').innerHTML = filteredPokemon.map(renderPokemon).join('');
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => searchPokemon(e.target.value), 300);
        });

        // Inicialización
        initializeTeamSlots();
        loadPokemon();

        // Cerrar detalles al hacer clic fuera
        document.addEventListener('click', (e) => {
            const details = document.getElementById('pokemonDetails');
            if (e.target === details) {
                closeDetails();
            }
        });

        // Función para cambiar de equipo
        function changeTeam() {
            currentTeam = document.getElementById('teamSelector').value;
            updateTeamDisplay();
            updatePokemonGrid();
        }

        // Función para crear un nuevo equipo
        function createNewTeam() {
            const teamName = `team${++teamCounter}`;
            teams[teamName] = new Array(6).fill(null);
            
            const selector = document.getElementById('teamSelector');
            const option = document.createElement('option');
            option.value = teamName;
            option.textContent = `Equipo ${teamCounter}`;
            selector.appendChild(option);
            selector.value = teamName;
            
            currentTeam = teamName;
            updateTeamDisplay();
            updatePokemonGrid();
        }

        // Función para eliminar el equipo actual
        function deleteCurrentTeam() {
            if (Object.keys(teams).length <= 2) {
                alert('Debe haber al menos dos equipos');
                return;
            }

            if (confirm('¿Estás seguro de que quieres eliminar este equipo?')) {
                const selector = document.getElementById('teamSelector');
                const option = selector.options[selector.selectedIndex];
                selector.removeChild(option);
                delete teams[currentTeam];
                currentTeam = 'team1';
                selector.value = currentTeam;
                updateTeamDisplay();
                updatePokemonGrid();
            }
        }

        // Función para iniciar la batalla
        function startBattle() {
            const team1 = teams.team1.filter(id => id !== null);
            const team2 = teams.team2.filter(id => id !== null);

            if (team1.length === 0 || team2.length === 0) {
                alert('Ambos equipos deben tener al menos un Pokémon');
                return;
            }

            // Preparar datos de los equipos
            const battleTeams = {
                team1: team1.map(id => {
                    const pokemon = allPokemon.find(p => p.id === id);
                    return {
                        id: pokemon.id,
                        name: pokemon.name,
                        types: pokemon.types,
                        health: pokemon.health,
                        maxHealth: pokemon.maxHealth,
                        attack: pokemon.attack,
                        defense: pokemon.defense,
                        speed: pokemon.speed,
                        specialAttack: pokemon.specialAttack,
                        specialDefense: pokemon.specialDefense,
                        imageUrl: pokemon.imageUrl,
                        moves: pokemon.moves
                    };
                }),
                team2: team2.map(id => {
                    const pokemon = allPokemon.find(p => p.id === id);
                    return {
                        id: pokemon.id,
                        name: pokemon.name,
                        types: pokemon.types,
                        health: pokemon.health,
                        maxHealth: pokemon.maxHealth,
                        attack: pokemon.attack,
                        defense: pokemon.defense,
                        speed: pokemon.speed,
                        specialAttack: pokemon.specialAttack,
                        specialDefense: pokemon.specialDefense,
                        imageUrl: pokemon.imageUrl,
                        moves: pokemon.moves
                    };
                })
            };

            // Guardar datos de la batalla
            localStorage.setItem('battleTeams', JSON.stringify(battleTeams));

            // Redirigir a la página de batalla
            window.location.href = 'battle.html';
        }
    </script>
</body>
</html> 